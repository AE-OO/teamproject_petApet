<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragment/heade :: head(product)}">
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<th:block th:replace="~{fragment/header :: header}"></th:block>
<hr class="mt-5">
<div class="container-xxl py-5">
    <div class="container">
        <div class="text-center mx-auto">
            <p class="fs-5 fw-bold text-primary">Pet A Pet</p>
            <h1 class="display-5 mb-3" th:text="${productDiv}">Pet Food</h1>
        </div>
        <div class="row wow fadeInUp" data-wow-delay="0.3s">
            <div class="col-12 text-center">
                <ul class="list-inline rounded mb-4" id="portfolio-flters">
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=all)}">전체보기</a></li>
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=food)}">사료</a></li>
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=snack)}">간식</a></li>
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=walking)}">산책용품</a></li>
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=toy)}">장난감</a></li>
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=fashion)}">패션/잡화</a></li>
                    <li class="mx-2"><a style="text-decoration: none"
                                        th:href="@{/product(category=stroller)}">유모차</a></li>
                </ul>
            </div>
        </div>
        <form class="d-flex col justify-content-end" th:action="@{/product/search}" method="get">
            <div class="col-6">
                <div class="input-group mb-2">
                    <div class="col-3">
                        <select class="form-select" type="input"
                                name="category">
                            <option value="all" selected>전체</option>
                            <option value="food">사료</option>
                            <option value="snack">간식</option>
                            <option value="walking">산책용품</option>
                            <option value="toy">장난감</option>
                            <option value="fashion">패션/잡화</option>
                            <option value="stroller">유모차</option>
                        </select>
                    </div>
                    <input type="text" class="form-control" placeholder="찾고 싶은 상품을 입력하세요" name="searchContent"
                           aria-label="Recipient's username" aria-describedby="button-addon2">
                    <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Button</button>
                </div>
            </div>
        </form>
        <div class="wow fadeInUp" data-wow-delay="0.4s"
             style="visibility: visible; animation-delay: 0.4s; animation-name: fadeInUp;">
            <hr class="">
        </div>
        <div class="row mb-3"></div>
        <div class="row g-4 portfolio-container " style="position: relative; height: auto;">
            <div class="col-lg-3 col-md-6 portfolio-item first wow fadeInUp"
                 data-wow-delay="0.1s" th:each="product, i : ${productList}">
                <div class="portfolio rounded">
                    <img class=""
                         th:src="|@{/product/images/{filename}(filename=${product.productImg.get(0).storeFileName})}|"
                         width="300" height="300" alt=""/>
                    <div class="portfolio-text" style="opacity: 1;">
                        <h1 class="text-start rounded ms-2">
                            <a style="text-decoration: none;" class="text-dark fs-5"
                               th:href="|@{/product/{productType}/{productId}/details(productType=${product.productDiv.name().toLowerCase()},productId=${product.productId})}|"
                               th:text="${product.productName}"></a>
                        </h1>
                        <div class="d-flex flex-row">
                            <div>
                                <fieldset class="p-1">
                                    <div class="d-flex flex-row" style="max-height: 1rem; margin-top: 0.1rem">
                                        <p th:class="star" th:value="${product.productRating}">
                                            <a class="my_star" value="1">★</a>
                                            <a class="my_star" value="2">★</a>
                                            <a class="my_star" value="3">★</a>
                                            <a class="my_star" value="4">★</a>
                                            <a class="my_star" value="5">★</a>
                                        <p>
                                    </div>
                                </fieldset>
                            </div>
                            <div>
                                <h6 class="align-self-center mt-2" th:text="|(${product.review.size()})|">(0)</h6>
                            </div>
                            <div class="col text-end align-self-end m-0 p-0">
                                <th:block th:if="${product.productDiscountRate>0}">
                                    <span><i><h5 style="text-decoration: line-through;" class="fs-6 text-end"
                                                 th:text="|${product.productUnitPrice}원|"></h5></i></span>
                                </th:block>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <div class="row col">
                                <th:block th:if="${product.productDiscountRate==0}">
                                    <h1 class="fs-5 text-end"
                                        th:text="|${#numbers.formatInteger(product.productPrice, 3, 'COMMA')}원|"></h1>
                                </th:block>
                                <th:block th:if="${product.productDiscountRate>0}">
                                    <div class="col-4">
                                        <h1 class="fs-6 align-self-end" style="color: red"
                                            th:text="|${product.productDiscountRate}%할인|"></h1>
                                    </div>
                                    <div class="col-8">
                                        <h1 class="fs-5 text-end"
                                            th:text="|${#numbers.formatInteger(product.productPrice, 3, 'COMMA')}원|"></h1>
                                    </div>
                                </th:block>
                            </div>
                            <div class="d-flex flex-row">
                                <div id="dib" class="justify-content-start">
                                    <th:block th:if="${product.duplicateDibsProduct}">
                                        <p class="p-0 m-0" style="font-size: 1.5rem"><a role="button"
                                                                                        style="color: red">♥︎</a></p>
                                    </th:block>
                                    <th:block th:if="${!product.duplicateDibsProduct}">
                                        <p class="p-0 m-0" style="font-size: 1.5rem"><a role="button"
                                                                                        th:id="${product.productId}"
                                                                                        onclick="addDibs(this.getAttribute('id'))"
                                                                                        style="color: red">♡</a></p>
                                    </th:block>
                                </div>
                                <div class="d-flex flex-fill justify-content-sm-end btn-group-sm">
                                    <button type="button" class="btn bg-secondary me-1 addCart"
                                            th:value="*{product.productId}">장바구니
                                        <input type="hidden" class="quan" value="1"/></button>
                                    <button class="btn bg-secondary addBuy"
                                            th:onclick="|location.href='@{/direct/checkout/{idx}(idx=${product.productId})}'|">
                                        바로구매
                                        <input type="hidden" class="quan" value="1"/></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<hr class="my-4">
<th:block th:replace="~{fragment/layout :: mainFooter}"></th:block>
</body>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    var size = $('p[class = star]').length;
    for (var i = 0; i < size; i++) {
        $('p[class = star]').eq(i).attr('id', "star" + i);

        $("#star" + i).find(".my_star").filter(function (k, v) {
            return $(v).attr("value") <= $("#star" + i).attr('value') ? $(v).addClass("on") : $(v).removeClass("on");
        });
    }

    function addDibs(id) {
        $.ajax({
            type: 'post',           // 타입 (get, post, put 등등)
            url: '/product/dibs/add',           // 요청할 서버url
            async: true,            // 비동기화 여부 (default : true)
            dataType: 'text',       // 데이터 타입 (html, xml, json, text 등등)
            data: {"productId": id},
            success: function (result) { // 결과 성공 콜백함수
                if (result === 'login') {
                    location.href = '/login'
                }
                if (result === 'duplicate') {
                    console.log(result)
                } else {
                    console.log(result)
                }
            },
            error: function (request, status, error) { // 결과 에러 콜백함수
                console.log(error)
            }
        })
    }
</script>
<script th:inline="javascript">

    const addCartBtn = $('.addCart');  // 상품 리스트에서 장바구니로 상품을 추가하는 기능

    $(addCartBtn).click(function () {
        var productId = $(this).val();
        var quantity = $(this).children('.quan').val();
        var param = {"product": productId, "quantity": quantity};
        console.log("product : " + productId);
        console.log("quantity : " + quantity);
        $.ajax({
            url: "/cart/add",
            type: "POST",
            data: JSON.stringify(param),
            dataType: "text",
            contentType: "application/json",
            charset: "UTF-8",
            success: function (data) {
                alert("장바구니 추가되었음")
            },
            error: function (jqXHR, status, errorThrown) {
                alert("에러");
            }
        });
    });

</script>

<!-- Template Javascript -->
<script th:src="@{/js/main.js}"></script>
</html>