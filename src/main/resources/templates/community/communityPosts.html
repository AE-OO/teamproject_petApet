<!DOCTYPE html>
<html lang="en">
<head th:replace="fragment/saron_base :: base(~{::title},~{::link},~{::script})">
    <title>petApet - 커뮤니티</title>
    <link>
    <script th:inline="javaScript">
        let cId = [[${posts.communityId}]]
        let loginId = [[${#authentication.name}]]
        zoom = function (value) {
            if ($(value).hasClass("zoom-in")) {
                $(value).attr("width", "");
                $(value).attr("height", "");
            } else {
                $(value).attr("width", "130");
                $(value).attr("height", "130");
            }
            $(value).toggleClass("zoom-in");
            $(value).toggleClass("zoom-out");
        }
        setThumbnail = function (event) {
            let from = Array.from(event.target.files);
            $('#thumbnailImg').empty();
            $.each(from, function (idx, el) {
                let reader = new FileReader();
                reader.onload = function (event) {
                    $("#thumbnailImg").attr("src", event.target.result);
                    $("#thumbnailImgDiv").removeClass('d-none');
                };
                reader.readAsDataURL(el);
            });
        }
        submitComment = function () {
            let commentSercretRes = "";
            if ($("#lockIcon").hasClass("bi-lock-fill")) {
                commentSercretRes = "Y";
            }else{
                commentSercretRes = "N";
            }
            let test = {
                communityId: cId,
                commentContent: $("#commentContent").val(),
                commentSecret: commentSercretRes,
            }
            // alert($('#inputFile').val())
            let formData = new FormData();
            formData.append("commentInsertDTO", new Blob([JSON.stringify(test)], {type: "application/json"}));
            formData.append("commentImg", $('#inputFile').get(0).files[0]);

            $.ajax({
                url: "/comment/insert",
                type: "post",
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log('success');
                    getCommentList();
                    $("#commentContent").val('');
                }
                , error: function () {
                    alert('오류가 발생하였습니다.');
                }
            });
        }
        getCommentList = function () {
            $.ajax({
                url: "/comment",
                type: "post",
                data: {communityId: cId},
                dateType: "json",
                success: function (data) {
                    window.location="/community/"+cId
                    // showList(data);
                }
                , error: function () {
                    alert('오류가 발생하였습니다.');
                }
            })
        }

        // getPageSelect = function (data){
        //     alert("/?");
        //     let page = '';
        //     // if(data.isFirst()){
        //     //     $("#prevPage").addClass("disabled")
        //     // }
        //     // if(data.isLast()){
        //     //     $("#nextPage").addClass("disabled")
        //     // }
        //     // if(data.hasPrevious()){
        //     //     $("#prevPageA").attr("style","")
        //     // }
        //     // if(data.hasNext()){
        //     //     $("#nextPageA").attr("style","")
        //     // }
        //     //
        //     // $.each(data, function (idx, val) {
        //     //     page += $("#commentForm").html();
        //     //     // str += $("#commentList").html();
        //     // });
        //     //
        //     // // if(data.getTotalPages()>5){
        //     // //
        //     // // }
        //     // $("#commentPage").html(page);
        //
        //     // <div aria-label="Page navigation">
        //     //         <li th:each="page : ${#numbers.sequence(1,community.getTotalPages())}"
        //     //             th:class="${community.getNumber()+1 == page}? 'page-item active':'page-item'">
        //     //             <a className="page-link"
        //     //                th:href="|javascript:selectPageNum(${page})|"><span>[[${page}]]</span></a>
        //     //         </li>
        //     //         <li th:if="${community.getTotalPages()}>5" className="disabled"><a>...</a></li>
        //     //         <li th:if="${community.getTotalPages()}>5">
        //     //             <a href="#" th:text="${community.getTotalPages()}"></a>
        //     //         </li>
        //     //     </ul>
        //     // </div>
        // }

        showList = function (data) {
            let secretIcon = "<i class='bi bi-lock-fill text-secondary me-1'></i>"
            let str = '';
            $.each(data, function (idx, val) {

                $('.commentUpdate').remove();
                $('.commentDelete').remove();
                if (loginId == val.memberId) {
                    $('.commentBg').addClass("bg-light");
                    $('.commentInfo').append("<li><a class='dropdown-item commentUpdate' href='#'>수정</a></li>");
                    $('.commentInfo').append("<li><a class='dropdown-item commentDelete' href='#'>삭제</a></li>");
                }

                $('.commentWriter').text(val.memberId);

                if (val.memberImg == 0) {
                    $('.commentProfile').attr("src", "/img/profile.jpg");
                } else {
                    $('.commentProfile').attr("src", "/image/" + val.memberImg);
                }

                $('.commentDate').text(val.modifiedDate);
                if (val.commentSecret === "Y") {
                    // $('.commentContent').html(secretIcon);
                    $('.commentContent').html(secretIcon + val.commentContent);
                } else {
                    $('.commentContent').text(val.commentContent);
                }


                if (val.commentImg == 0) {
                    $(".commentImg").hide()
                } else {
                    $(".commentImg").attr("src", "/image/" + val.commentImg)
                    $(".commentImg").show()
                }

                str += $("#commentForm").html();

                // str += $("#commentList").html();
            });

            $("#commentListSize").text(data.length);
            $("#commentList").html(str);
        }

        $(function () {
            // getCommentList();
            $("#commentContent").keyup(function () {
                $("#commentLength").text($("#commentContent").val().length);
            });
            $("#commentSubmitBtn").click(function () {
                if ($("#commentContent").val() == '') {
                    alert("내용을 입력해주세요");
                    return;
                } else {
                    submitComment();
                }
            });
            $("#lockBtn").click(function () {
                $("#lockIcon").toggleClass("bi-unlock-fill");
                $("#lockIcon").toggleClass("text-gray");
                $("#lockIcon").toggleClass("bi-lock-fill");
                $("#lockIcon").toggleClass("text-danger");
            });
            $("#commentImgBtn").click(function () {
                // $("#inputFile").val('');

                $("#inputFile").click();
            });
            // $("#inputFile").change(function (event) {
            //     setThumbnail(event);
            // });
            $("#imgRemoveBtn").click(function () {
                $("#inputFile").val('');
                $("#thumbnailImgDiv").addClass(' d-none');
                $("#thumbnailImg").attr("src", "");
            });
            $("#communityBtn").click(function () {
                window.location="/community";
            });

            $("#postsDelete").click(function () {
                let arr = [];
                $("#postsContent").find("img").each(function(index, item){
                    // arr[index] = $(this).attr('src').substr(16)
                    arr.push($(this).attr('src').substr(16))
                });
                $.ajax({
                    type: "POST",
                    url: "/community/delete",
                    data: {
                        communityId: cId,
                        deleteImg :arr,
                    },
                    dataType: "json",
                    success: function (result) {
                        alert("삭제가 완료되었습니다.");
                        window.location = "/community";
                    },
                    // error: function () {
                    //     alert("오류가 발생했습니다.");
                    // },
                    complete : function(data) {
                        alert("삭제가 완료되었습니다.");
                        window.location = "/community";
                        //  실패했어도 완료가 되었을 때 처리
                    }
                });
            });
            $("#postsUpdate").click(function () {
                let form = document.createElement('form');
                let communityId;
                communityId = document.createElement('input');
                communityId.setAttribute('type', 'hidden');
                communityId.setAttribute('name', 'communityId');
                communityId.setAttribute('value', cId);
                form.appendChild(communityId);
                form.setAttribute('method', 'post');
                form.setAttribute('action', '/community/update');
                document.body.appendChild(form);
                form.submit();
            });
        });
    </script>

</head>
<body>
<th:block th:replace="~{fragment/header :: header}"></th:block>
<hr class="mt-5">
<div class="container-xxl">
    <div class="container p-5">
        <div class="text-center mb-4">
            <p class="fs-5 fw-bold text-primary">Pet A Pet</p>
            <h1 class="display-5 mb-3">Pet Community</h1>
            <hr class="mt-0 mb-3"/>
        </div>
        <div class="col-12" sec:authorize="isAnonymous()">
            <div class="border p-5">
                <h4>커뮤니티 게시판 권한 안내</h4>
                <hr class="mt-1"/>
                <div>
                    <p class="pt-0 mb-0">회원님은 아직 로그인을 하지 않으셨어요. 먼저 로그인을 하시고 이용해주세요.</p>
                    <p class="pt-0 mb-0">petApet 계정이 없다면, 회원가입을 해주세요.</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button type="button" onclick="location.href='/community'" class="btn btn-info">되돌아가기</button>
                <button type="button" onclick="location.href='/login'" class="btn btn-primary">로그인</button>
                <button type="button" onclick="location.href='/join'" class="btn btn-danger">회원가입</button>
            </div>
        </div>

        <div class="col-12" sec:authorize="isAuthenticated()">
            <div class="border p-5 pb-8">
                <h5><span class="text-danger" th:text="${posts.communityCategory}"/></h5>
                <h4>
                    <span class="me-2" style="color:#888;" th:text="${posts.communitySubCategory}"/>
                    [[${posts.communityTitle}]]</h4>
                <img class="rounded-circle border border-1 me-1 my-1"
                     th:src="${posts.memberImg}==0? '/img/profile.jpg':'/image/'+${posts.memberImg}"
                     width="50" height="50" style="object-fit: cover;">
                <div class="dropdown mx-1 d-inline-block">
                    <a href="javascript:" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                       th:text="${posts.memberId}"/>
                    <ul class="dropdown-menu" style="min-width: auto;">
                        <li><a class="dropdown-item" href="javascript:">회원정보</a></li>
                        <li><a class="dropdown-item" href="javascript:">작성글보기</a></li>
                        <li><a class="dropdown-item" href="javascript:">쪽지보내기</a></li>
                        <li><a class="dropdown-item" href="javascript:">신고하기</a></li>
                    </ul>
                </div>
                <span class="mx-1" th:text="'조회 '+${posts.viewCount}"/>
                <span class="mx-1" th:text="${#temporals.format(posts.modifiedDate,'yyyy-MM-dd HH:mm')}"/>
                <span>댓글</span>
                <span id="commentListSize" class="text-danger" th:text="${posts.commentListSize}"/>
                <div class="float-end">
                    <button id="postsUpdate"
                            type="button" class="btn btn-info" th:if="${#authentication.name == posts.memberId}">수정
                    </button>
                    <button id="postsDelete" type="button" class="btn btn-danger"
                            th:if="${#authentication.name == posts.memberId}">삭제
                    </button>
                </div>
                <hr class="mt-1 mb-4"/>
                <div id="postsContent" th:utext="${posts.communityContent}"/>
            </div>
            <div class="bg-lightGray pt-1 pb-5">
                <div id="commentList" th:if="${posts.commentListSize} != 0">
                    <div th:each=" comment : ${comment}">
                        <div th:if="${comment.commentSecret}=='Y'"
                             th:class="${#authentication.name == comment.memberId}? 'bg-light px-5 py-3 commentBg':'px-5 py-3 commentBg'">
                            <div th:if="${#authentication.name == comment.memberId} or ${#authentication.name == posts.memberId}
                                 or ${#authentication.authorities == 'ADMIN'}">
                                <div class="d-inline-block me-2">
                                    <img class="rounded-circle border border-1"
                                         th:src="${comment.memberImg}==0? '/img/profile.jpg':'/image/'+${comment.memberImg}"
                                         width="60" height="60" style="object-fit:cover">
                                </div>
                                <div class="d-inline-block align-middle">
                                    <div class="dropdown me-1 d-inline-block">
                                        <a href="javascript:" class="commentWriter" role="button"
                                           data-bs-toggle="dropdown"
                                           aria-expanded="false" th:text="${comment.memberId}"></a>
                                        <ul class="dropdown-menu" style="min-width: auto;">
                                            <li><a class="dropdown-item" href="javascript:">회원정보</a></li>
                                            <li><a class="dropdown-item" href="javascript:">작성글보기</a></li>
                                            <li><a class="dropdown-item" href="javascript:">쪽지보내기</a></li>
                                            <li><a class="dropdown-item" href="javascript:">신고하기</a></li>
                                        </ul>
                                    </div>
                                    <span class="float-none mx-1 commentDate" th:text="${comment.modifiedDate}"></span>
                                    <p class="pt-0 m-0 commentContent">
                                        <i th:if="${comment.commentSecret == 'Y'}"
                                           class='bi bi-lock-fill text-secondary me-1'></i>
                                        <span th:text="${comment.commentContent}"/>
                                    </p>
                                </div>
                                <div class="dropdown mt-2 float-end">
                                    <button class="btn btn-link2" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical m-auto fs-5"></i></button>
                                    <ul class="dropdown-menu" style="min-width:auto;">
                                        <li><a class="dropdown-item commentInfo" href="#">답글</a></li>
                                        <li th:if="${#authentication.name == comment.memberId}"><a
                                                class="dropdown-item commentUpdate" href="#">수정</a></li>
                                        <li th:if="${#authentication.name == comment.memberId}"><a
                                                class="dropdown-item commentDelete" href="#">삭제</a></li>
                                    </ul>
                                </div>
                                <div class="ms-6" th:unless="${comment.commentImg}==0">
                                    <img th:src="'/image/'+${comment.commentImg}"
                                         class="zoom-in commentImg" onclick="zoom(this)"
                                         width="130" height="130" style="object-fit: cover;">
                                </div>
                            </div>
                            <div th:unless="${#authentication.name == comment.memberId} or ${#authentication.name == posts.memberId}
                                 or ${#authentication.authorities == 'ADMIN'}">
                                <div class="d-inline-block align-middle">
                                    <i th:if="${comment.commentSecret == 'Y'}"
                                       class='bi bi-lock-fill text-secondary me-1'></i>
                                    <span class="pt-0 m-0 commentContent">해당 댓글은 작성자와 운영자만 볼 수 있습니다.</span>
                                    <span class="float-none mx-1 commentDate" th:text="${comment.modifiedDate}"></span>
                                </div>
                            </div>
                        </div>
                        <div th:unless="${comment.commentSecret}=='Y'"
                             th:class="${#authentication.name == comment.memberId}? 'bg-light px-5 py-3 commentBg':'px-5 py-3 commentBg'">
                            <div class="d-inline-block me-2">
                                <img class="rounded-circle border border-1"
                                     th:src="${comment.memberImg}==0? '/img/profile.jpg':'/image/'+${comment.memberImg}"
                                     width="60" height="60" style="object-fit:cover">
                            </div>
                            <div class="d-inline-block align-middle">
                                <div class="dropdown me-1 d-inline-block">
                                    <a href="javascript:" class="commentWriter" role="button" data-bs-toggle="dropdown"
                                       aria-expanded="false" th:text="${comment.memberId}"></a>
                                    <ul class="dropdown-menu" style="min-width: auto;">
                                        <li><a class="dropdown-item" href="javascript:">회원정보</a></li>
                                        <li><a class="dropdown-item" href="javascript:">작성글보기</a></li>
                                        <li><a class="dropdown-item" href="javascript:">쪽지보내기</a></li>
                                        <li><a class="dropdown-item" href="javascript:">신고하기</a></li>
                                    </ul>
                                </div>
                                <span class="float-none mx-1 commentDate" th:text="${comment.modifiedDate}"></span>
                                <p class="pt-0 m-0 commentContent">
                                    <i th:if="${comment.commentSecret == 'Y'}"
                                       class='bi bi-lock-fill text-secondary me-1'></i>
                                    <span th:text="${comment.commentContent}"/>
                                </p>
                            </div>
                            <div class="dropdown mt-2 float-end">
                                <button class="btn btn-link2" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical m-auto fs-5"></i></button>
                                <ul class="dropdown-menu" style="min-width:auto;">
                                    <li><a class="dropdown-item commentInfo" href="#">답글</a></li>
                                    <li th:if="${#authentication.name == comment.memberId}"><a
                                            class="dropdown-item commentUpdate" href="#">수정</a></li>
                                    <li th:if="${#authentication.name == comment.memberId}"><a
                                            class="dropdown-item commentDelete" href="#">삭제</a></li>
                                </ul>
                            </div>
                            <div class="ms-6" th:unless="${comment.commentImg}==0">
                                <img th:src="'/image/'+${comment.commentImg}"
                                     class="zoom-in commentImg" onclick="zoom(this)"
                                     width="130" height="130" style="object-fit: cover;">
                            </div>
                        </div>
                        <hr class="m-0">
                    </div>
                </div>

                <div aria-label="Page navigation" class="mt-4" th:if="${comment.getTotalPages()}!=0">
                    <ul id="pageNum" class="pagination justify-content-center">
                        <li id="prevPage" th:class="${comment.isFirst()}? 'page-item disabled':'page-item'">
                            <a class="page-link" href="javascript:"
                               th:style="${comment.hasPrevious()}? '':'pointer-events: none;'">
                                <span aria-hidden="true"><i class="bi bi-chevron-left"></i></span>
                            </a>
                        </li>
                        <li th:if="${(comment.getTotalPages()>5 && comment.getNumber()+1>=comment.getTotalPages()-4)||(comment.getTotalPages()>5 && comment.getNumber()+1>5)}"
                            class="page-item"><a class="page-link selectPage" href="javascript:" th:text="1"></a></li>
                        <li th:if="${(comment.getTotalPages()>5 && comment.getNumber()+1>=comment.getTotalPages()-4)||(comment.getTotalPages()>5 && comment.getNumber()+1>5)}"
                            class="page-item disabled"><a class="page-link">...</a></li>
                        <li th:if="${comment.getTotalPages()<6} "
                            th:each="page:${#numbers.sequence(1,comment.getTotalPages())}"
                            th:class="${comment.getNumber()+1 == page}? 'page-item active':'page-item'">
                            <a class="page-link selectPage" href="javascript:"><span th:text="${page}"/></a>
                        </li>
                        <li th:if="${comment.getNumber()+1<6 && comment.getTotalPages()>5 && comment.getNumber()+1<comment.getTotalPages()-4}"
                            th:each="page:${#numbers.sequence(1,5)}"
                            th:class="${comment.getNumber()+1 == page}? 'page-item active':'page-item'">
                            <a class="page-link selectPage" href="javascript:"><span th:text="${page}"/></a>
                        </li>
                        <li th:if="${comment.getNumber()+1>5 && comment.getTotalPages()>5 && comment.getNumber()+1<comment.getTotalPages()-4}"
                            th:each="page : ${#numbers.sequence(comment.getNumber()-2+1,comment.getNumber()+2+1)}"
                            th:class="${comment.getNumber()+1 == page}? 'page-item active':'page-item'">
                            <a class="page-link selectPage" href="javascript:"><span th:text="${page}"/></a>
                        </li>
                        <li th:if="${comment.getTotalPages()>5 && comment.getNumber()+1>=comment.getTotalPages()-4}"
                            th:each="page : ${#numbers.sequence(comment.getTotalPages()-4,comment.getTotalPages())}"
                            th:class="${comment.getNumber()+1 == page}? 'page-item active':'page-item'">
                            <a class="page-link selectPage" href="javascript:"><span th:text="${page}"/></a>
                        </li>
                        <li th:if="${comment.getTotalPages()>5 && comment.getNumber()+1<comment.getTotalPages()-4}"
                            class="page-item disabled"><a class="page-link">...</a></li>
                        <li th:if="${comment.getTotalPages()>5 && comment.getNumber()+1<comment.getTotalPages()-4}"
                            class="page-item"><a class="page-link selectPage" href="javascript:"
                                                 th:text="${comment.getTotalPages()}"></a>
                        </li>
                        <li id="nextPage" th:class="${comment.isLast()}? 'page-item disabled':'page-item'">
                            <a class="page-link" href="javascript:"
                               th:style="${comment.hasNext()}? '':'pointer-events: none;'">
                                <span aria-hidden="true"><i class="bi bi-chevron-right"></i></span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="bg-white m-5 p-4 pt-2" sec:authorize="hasAnyRole('MEMBER','ADMIN')">
                        <textarea id="commentContent" style="resize:none; height: 100px; border:none;"
                                  class="w-100 form-control px-1 "
                                  placeholder="인터넷은 우리가 함께 만들어가는 소중한 공간입니다. 댓글 작성 시 타인에 대한 배려와 책임을 담아주세요."
                                  maxlength="600"></textarea>
                    <div id="thumbnailImgDiv" class="my-3 position-relative w-fit-content d-none">
                        <img id="thumbnailImg" class="border" width="150" height="150" style="object-fit: cover;">
                        <button id="imgRemoveBtn" type="button"
                                class="btn-close btn-close-white bg-dark position-absolute top-0 end-0 rounded-0"
                                aria-label="Close"></button>
                    </div>
                    <input type="file" id="inputFile" class="form-control d-none"
                           onchange="setThumbnail(event)" accept=".gif, .jpg, .png">
                    <div class="text-end mt-2">
                        <button id="commentImgBtn" class="btn btn-link2 float-start p-0">
                            <i class="bi bi-image fs-4 mt-3"></i>
                        </button>
                        <span id="commentLength">0</span><span
                            class="text-grey">/600</span>
                        <button id="lockBtn" class="btn btn-link2 mx-2 p-0 ">
                            <i id="lockIcon" class="bi bi-unlock-fill fs-4 m-0"></i>
                        </button>
                        <button type="button" id="commentSubmitBtn" class="btn btn-danger text-end">등록</button>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button type="button" id="communityBtn" class="btn btn-primary">글목록</button>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Back to Top -->
<a href="#" class="btn btn-lg btn-dark btn-lg-square rounded-circle back-to-top"><i class="bi bi-arrow-up"></i></a>
<th:block th:replace="~{fragment/layout :: mainFooter}"></th:block>
<div id="commentForm" th:if="${posts.commentListSize} != 0" class="d-none">
    <div class="px-5 py-3 commentBg">
        <div class="d-inline-block me-2">
            <img class="rounded-circle border border-1 commentProfile" src="" width="60" height="60"
                 style="object-fit:cover">
        </div>
        <div class="d-inline-block align-middle">
            <div class="dropdown me-1 d-inline-block">
                <a href="javascript:" class="commentWriter" role="button" data-bs-toggle="dropdown"
                   aria-expanded="false"></a>
                <ul class="dropdown-menu" style="min-width: auto;">
                    <li><a class="dropdown-item" href="javascript:">회원정보</a></li>
                    <li><a class="dropdown-item" href="javascript:">작성글보기</a></li>
                    <li><a class="dropdown-item" href="javascript:">쪽지보내기</a></li>
                    <li><a class="dropdown-item" href="javascript:">신고하기</a></li>
                </ul>
            </div>
            <span class="float-none mx-1 commentDate"></span>
            <p class="pt-0 m-0 commentContent"></p>
        </div>
        <div class="dropdown mt-2 float-end">
            <button class="btn btn-link2" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots-vertical m-auto fs-5"></i></button>
            <ul class="dropdown-menu" style="min-width:auto;">
                <li><a class="dropdown-item commentInfo" href="#">답글</a></li>
                <li><a class="dropdown-item commentUpdate" href="#">수정</a></li>
                <li><a class="dropdown-item commentDelete" href="#">삭제</a></li>
            </ul>
        </div>
        <div class="ms-6">
            <img src="" class="zoom-in commentImg" onclick="zoom(this)"
                 width="130" height="130" style="object-fit: cover;">
        </div>
    </div>
    <hr class="m-0">
</div>
<div id="testtesttest" th:if="${posts.commentListSize} != 0" class="d-none"
     sec:authorize="hasAnyRole('MEMBER','ADMIN')">
    <div class="px-5 py-3 commentBg">
        <div class="me-2">
            <i class='bi bi-lock-fill text-secondary me-1'></i>
        </div>
    </div>
    <hr class="m-0">
</div>
</body>
</html>